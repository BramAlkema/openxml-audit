name: Validate inputs

on:
  push:
    paths:
      - "inputs/**"
      - ".github/workflows/validate-inputs.yml"
  pull_request:
    paths:
      - "inputs/**"
      - ".github/workflows/validate-inputs.yml"
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Prepare reports directory
        run: mkdir -p reports

      - name: Run Python validator
        continue-on-error: true
        run: |
          openxml-audit inputs --recursive --output json > reports/python.json

      - name: Run SDK validator
        continue-on-error: true
        run: |
          python - <<'PY'
          from pathlib import Path
          import json
          import subprocess
          import sys

          root = Path("inputs")
          exts = {
              ".docx", ".docm", ".dotx", ".dotm",
              ".pptx", ".pptm", ".potx", ".potm", ".ppsx", ".ppsm", ".ppam", ".thmx",
              ".xlsx", ".xlsm", ".xltx", ".xltm", ".xlam",
          }
          files = [str(p) for p in root.rglob("*") if p.suffix.lower() in exts]
          if not files:
              Path("reports/sdk.json").write_text("[]", encoding="utf-8")
              sys.exit(0)

          cmd = [
              "dotnet",
              "run",
              "--project",
              "scripts/sdk_compare/OpenXmlSdkValidator.csproj",
              "--",
              *files,
          ]
          result = subprocess.run(cmd, capture_output=True, text=True)
          output = result.stdout.strip() or "[]"
          Path("reports/sdk.json").write_text(output, encoding="utf-8")
          if result.returncode != 0:
              print(result.stdout)
              print(result.stderr, file=sys.stderr)
              sys.exit(result.returncode)
          PY

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: reports

      - name: Workflow summary
        if: always()
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          def load_json(path: Path):
              if not path.exists():
                  return []
              text = path.read_text(encoding="utf-8", errors="ignore").strip()
              if not text:
                  return []
              try:
                  return json.loads(text)
              except json.JSONDecodeError:
                  return []

          py_results = load_json(Path("reports/python.json"))
          sdk_results = load_json(Path("reports/sdk.json"))

          def py_invalid(results):
              return [r for r in results if not r.get("valid", True)]

          def sdk_invalid(results):
              return [r for r in results if r.get("Errors")]

          py_total = len(py_results)
          py_errors = sum(r.get("error_count", len(r.get("errors", []))) for r in py_results)
          py_invalid_files = py_invalid(py_results)

          sdk_total = len(sdk_results)
          sdk_errors = sum(len(r.get("Errors", [])) for r in sdk_results)
          sdk_invalid_files = sdk_invalid(sdk_results)

          summary = []
          summary.append("# Validation Summary")
          if py_total == 0 and sdk_total == 0:
              summary.append("No inputs found under `inputs/`.")
          else:
              summary.append("## Python validator")
              summary.append(f"- Files checked: {py_total}")
              summary.append(f"- Invalid files: {len(py_invalid_files)}")
              summary.append(f"- Total errors: {py_errors}")

              if py_invalid_files:
                  summary.append("")
                  summary.append("### Python invalid files")
                  for item in py_invalid_files[:20]:
                      summary.append(f"- {item.get('file')}")

              summary.append("")
              summary.append("## SDK validator (Office2019)")
              summary.append(f"- Files checked: {sdk_total}")
              summary.append(f"- Invalid files: {len(sdk_invalid_files)}")
              summary.append(f"- Total errors: {sdk_errors}")

              if sdk_invalid_files:
                  summary.append("")
                  summary.append("### SDK invalid files")
                  for item in sdk_invalid_files[:20]:
                      summary.append(f"- {item.get('File')}")

          Path("/tmp/summary.md").write_text("\\n".join(summary), encoding="utf-8")
          PY
          cat /tmp/summary.md >> "$GITHUB_STEP_SUMMARY"
